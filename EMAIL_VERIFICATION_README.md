# Восстановление пароля и верификация email - Инструкция

## Что было реализовано

### 1. Верификация email при регистрации
- При регистрации нового пользователя аккаунт создается в неактивном состоянии
- На указанный email отправляется письмо с ссылкой для подтверждения
- Пользователь должен перейти по ссылке, чтобы активировать аккаунт
- Ссылка действительна 24 часа

### 2. Восстановление пароля
- На странице входа добавлена ссылка "Забыли пароль?"
- Пользователь вводит email и получает письмо с инструкциями
- Ссылка для восстановления пароля действительна 1 час
- После перехода по ссылке можно установить новый пароль

### 3. Повторная отправка письма верификации
- Если письмо для подтверждения не пришло, можно запросить повторную отправку
- Ссылка доступна на странице входа

## Настройка email

### Для разработки
В настоящий момент используется `console.EmailBackend` - письма выводятся в консоль Docker-контейнера.

Чтобы просмотреть письма:
```bash
docker-compose logs web
```

### Для продакшена
1. Создайте файл `.env` в корне проекта
2. Добавьте настройки email:
```
EMAIL_HOST_USER=your-email@gmail.com
EMAIL_HOST_PASSWORD=your-app-password
```

3. В `settings.py` замените:
```python
EMAIL_BACKEND = 'django.core.mail.backends.console.EmailBackend'  # Закомментировать
EMAIL_BACKEND = 'django.core.mail.backends.smtp.EmailBackend'     # Раскомментировать
```

### Настройка Gmail
1. Включите двухфакторную аутентификацию
2. Создайте App Password в настройках Google аккаунта
3. Используйте этот пароль в EMAIL_HOST_PASSWORD

## URL-маршруты

Добавлены следующие маршруты:
- `/verify-email/<token>/` - подтверждение email
- `/resend-verification/` - повторная отправка письма верификации
- `/password-reset/` - запрос на восстановление пароля
- `/password-reset-confirm/<uidb64>/<token>/` - подтверждение восстановления пароля
- `/password-reset-complete/` - страница успешного восстановления

## Админ-панель

В админ-панели добавлена модель `EmailVerificationToken` для управления токенами верификации.

## Команды управления

Добавлена команда для очистки истёкших токенов:
```bash
docker-compose exec web python manage.py cleanup_verification_tokens
```

Опции:
- `--days N` - удалить токены старше N дней (по умолчанию 1)

## Безопасность

- Пароли сбрасываются с использованием встроенного токен-генератора Django
- Токены верификации email имеют срок действия 24 часа
- Токены восстановления пароля действительны 1 час
- Неактивированные пользователи не могут войти в систему

## Тестирование

1. Зарегистрируйте нового пользователя
2. Проверьте логи Docker для получения ссылки активации
3. Попробуйте войти до активации (должна появиться ошибка)
4. Активируйте аккаунт по ссылке
5. Протестируйте восстановление пароля

## Возможные улучшения

- Добавить капчу для защиты от спама
- Реализовать ограничения на количество попыток восстановления пароля
- Добавить уведомления о входе с нового устройства
- Интегрировать с внешними email-сервисами (SendGrid, Mailgun)
- Добавить двухфакторную аутентификацию
